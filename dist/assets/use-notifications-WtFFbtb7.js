import{r as o,a as G,k as p,l as h,t as s}from"./index-DkYP5wDW.js";import{u as V}from"./socket-context-DDlYDveF.js";function q(f){const{category:l,metadata:r}=f;if(r!=null&&r.url)return r.url;switch(l){case"MATCH":if(r!=null&&r.matchId)return`/matches/${r.matchId}`;break;case"LEAGUE":if(r!=null&&r.leagueId)return`/league/${r.leagueId}`;break;case"SEASON":if(r!=null&&r.seasonId)return`/seasons/${r.seasonId}`;break;case"DIVISION":if(r!=null&&r.divisionId)return`/divisions/${r.divisionId}`;break;case"PAYMENT":if(r!=null&&r.paymentId)return`/payments/${r.paymentId}`;if(r!=null&&r.userId)return`/players/${r.userId}`;break;case"CHAT":if(r!=null&&r.threadId)return`/chat/${r.threadId}`;break;case"ADMIN":if(r!=null&&r.disputeId)return`/disputes/${r.disputeId}`;if(r!=null&&r.reportId)return`/reports/${r.reportId}`;break}return null}const z=()=>{var m,C,N,E,$,v,x,D,O;const[f,l]=o.useState([]),[r,d]=o.useState(0),[P,M]=o.useState(!0),[I,S]=o.useState(!1),[g,b]=o.useState({page:1,limit:20,total:0,totalPages:0,hasMore:!1}),{socket:k}=V(),{data:e}=G(),u=o.useCallback(async(t={})=>{var n,i;if((n=e==null?void 0:e.user)!=null&&n.id)try{t.append?S(!0):M(!0);const a=new URLSearchParams;t.page&&a.append("page",t.page.toString()),t.limit&&a.append("limit",t.limit.toString()),t.unreadOnly&&a.append("unreadOnly","true"),t.archived!==void 0&&a.append("archived",t.archived.toString());const c=await p.get(`${h.notifications.getAll}?${a}`);if((i=c.data)!=null&&i.success){const y=c.data.data.notifications||[],w=c.data.data.pagination;t.append?l(B=>[...B,...y]):l(y),w&&b({page:w.page||1,limit:w.limit||20,total:w.total||0,totalPages:w.totalPages||0,hasMore:w.hasMore||!1})}}catch(a){console.error("Error fetching notifications:",a)}finally{M(!1),S(!1)}},[(m=e==null?void 0:e.user)==null?void 0:m.id]),R=o.useCallback(async()=>{I||!g.hasMore||await u({page:g.page+1,limit:g.limit,append:!0})},[u,I,g.hasMore,g.page,g.limit]),A=o.useCallback(async()=>{var t,n;if((t=e==null?void 0:e.user)!=null&&t.id)try{const i=await p.get(h.notifications.unreadCount);(n=i.data)!=null&&n.success&&d(i.data.data.unreadCount||0)}catch(i){console.error("Failed to fetch unread count:",i)}},[(C=e==null?void 0:e.user)==null?void 0:C.id]),U=o.useCallback(async t=>{var n;if((n=e==null?void 0:e.user)!=null&&n.id)try{await p.put(h.notifications.markRead(t)),l(i=>i.map(a=>a.id===t?{...a,read:!0,readAt:new Date().toISOString()}:a)),d(i=>Math.max(0,i-1))}catch(i){console.error("Error marking notification as read:",i)}},[(N=e==null?void 0:e.user)==null?void 0:N.id]),F=o.useCallback(async()=>{var t,n;if((t=e==null?void 0:e.user)!=null&&t.id)try{(n=(await p.put(h.notifications.markAllRead)).data)!=null&&n.success&&(l(a=>a.map(c=>({...c,read:!0,readAt:new Date}))),d(0),s.success("All notifications marked as read"))}catch(i){console.error("Error archiving notification:",i)}},[(E=e==null?void 0:e.user)==null?void 0:E.id]),L=o.useCallback(async t=>{var n;if((n=e==null?void 0:e.user)!=null&&n.id)try{const i=f.find(a=>a.id===t);await p.delete(h.notifications.delete(t)),l(a=>a.filter(c=>c.id!==t)),i&&!i.read&&d(a=>Math.max(0,a-1)),s.success("Notification deleted")}catch(i){console.error("Error deleting notification:",i),s.error("Failed to delete notification")}},[($=e==null?void 0:e.user)==null?void 0:$.id,f]),T=o.useCallback(async t=>{var n;if(!(!((n=e==null?void 0:e.user)!=null&&n.id)||t.length===0))try{const i=f.filter(a=>t.includes(a.id)&&!a.read).length;await p.post(h.notifications.deleteMany,{ids:t}),l(a=>a.filter(c=>!t.includes(c.id))),d(a=>Math.max(0,a-i)),s.success(`${t.length} notification${t.length>1?"s":""} deleted`)}catch(i){console.error("Error deleting notifications:",i),s.error("Failed to delete notifications")}},[(v=e==null?void 0:e.user)==null?void 0:v.id,f]),H=o.useCallback(async()=>{var t;if((t=e==null?void 0:e.user)!=null&&t.id)try{await p.delete(h.notifications.clearAll),l([]),d(0),b(n=>({...n,total:0,hasMore:!1})),s.success("All notifications cleared")}catch(n){console.error("Error clearing notifications:",n),s.error("Failed to clear notifications")}},[(x=e==null?void 0:e.user)==null?void 0:x.id]);return o.useCallback(()=>{u()},[u]),o.useEffect(()=>{var t;(t=e==null?void 0:e.user)!=null&&t.id&&(u(),A())},[(D=e==null?void 0:e.user)==null?void 0:D.id,u,A]),o.useEffect(()=>{var i;if(!k||!((i=e==null?void 0:e.user)!=null&&i.id))return;const t=a=>{l(c=>[a,...c]),a.read||d(c=>c+1),s(a.title||"New Notification",{description:a.message,duration:5e3})},n=a=>{l(c=>c.map(y=>y.id===a.notificationId?{...y,read:!0,readAt:new Date().toISOString()}:y)),d(c=>Math.max(0,c-1))};return k.on("notification:new",t),k.on("notification:read",n),()=>{k.off("notification:new",t),k.off("notification:read",n)}},[k,(O=e==null?void 0:e.user)==null?void 0:O.id,A]),{notifications:f,unreadCount:r,loading:P,loadingMore:I,pagination:g,fetchNotifications:u,fetchUnreadCount:A,markAsRead:U,markAllAsRead:F,deleteNotification:L,deleteMany:T,clearAll:H,loadMore:R,refresh:()=>{u(),A()}}};export{q as g,z as u};
